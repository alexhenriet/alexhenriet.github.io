<h1 id="command-option-argument">Command-Option-Argument</h1>

<p><a href="http://travis-ci.org/veged/coa"><img src="https://secure.travis-ci.org/veged/coa.png" alt="build status" /></a></p>

<h2 id="%F0%A7%F1%82%F0%BE-%F1%8D%F1%82%F0%BE%3F">Что это?</h2>

<p>COA — парсер параметров командной строки, позволяющий извлечь максимум пользы от формального API вашей программы.
Как только вы опишете определение в терминах команд, параметров и аргументов, вы автоматически получите:</p>

<ul>
<li>Справку для командной строки</li>
<li>API для использования программы как модуля в COA-совместимых программах</li>
<li>Автодополнение для командной строки</li>
</ul>

<h3 id="%F0%FF%F1%80%F0%BE%F1%87%F0%B8%F0%B5-%F0%B2%F0%BE%F0%B7%F0%BC%F0%BE%F0%B6%F0%BD%F0%BE%F1%81%F1%82%F0%B8">Прочие возможности</h3>

<ul>
<li>Широкий выбор настроек для параметров и аргументов, включая множественные значения, логические значения и обязательность параметров</li>
<li>Возможность асинхронного исполнения команд, используя промисы (используется библиотека <a href="https://github.com/kriskowal/q">Q</a>)</li>
<li>Простота использования существующих команд как подмодулей для новых команд</li>
<li>Комбинированная валидация и анализ сложных значений</li>
</ul>

<h2 id="%F0%FF%F1%80%F0%B8%F0%BC%F0%B5%F1%80%F1%8B">Примеры</h2>

<pre><code class="javascript">require('coa').Cmd() // декларация команды верхнего уровня
    .name(process.argv[1]) // имя команды верхнего уровня, берем из имени программы
    .title('Жутко полезная утилита для командной строки') // название для использования в справке и сообщениях
    .helpful() // добавляем поддержку справки командной строки (-h, --help)
    .opt() // добавляем параметр
        .name('version') // имя параметра для использования в API
        .title('Version') // текст для вывода в сообщениях
        .short('v') // короткое имя параметра: -v
        .long('version') // длинное имя параметра: --version
        .flag() // параметр не требует ввода значения
        .act(function(opts) {  // действия при вызове аргумента
            // результатом является вывод текстового сообщения
            return JSON.parse(require('fs').readFileSync(__dirname + '/package.json'))
                .version;
        })
        .end() // завершаем определение параметра и возвращаемся к определению верхнего уровня
    .cmd().name('subcommand').apply(require('./subcommand').COA).end() // загрузка подкоманды из модуля
    .cmd() // добавляем еще одну подкоманду
        .name('othercommand').title('Еще одна полезная подпрограмма').helpful()
        .opt()
            .name('input').title('input file, required')
            .short('i').long('input')
            .val(function(v) { // функция-валидатор, также может использоваться для трансформации значений параметров
                return require('fs').createReadStream(v) })
            .req() // параметр является обязательным
            .end() // завершаем определение параметра и возвращаемся к определению команды
        .end() // завершаем определение подкоманды и возвращаемся к определению команды верхнего уровня
    .run(process.argv.slice(2)); // разбираем process.argv и запускаем
</code></pre>

<pre><code class="javascript">// subcommand.js
exports.COA = function() {
    this
        .title('Полезная подпрограмма').helpful()
        .opt()
            .name('output').title('output file')
            .short('o').long('output')
            .output() // использовать стандартную настройку для параметра вывода
            .end()
};
</code></pre>

<h2 id="api">API</h2>

<h3 id="cmd">Cmd</h3>

<p>Команда — сущность верхнего уровня. У команды могут быть определены параметры и аргументы.</p>

<h4 id="cmd.api">Cmd.api</h4>

<p>Возвращает объект, который можно использовать в других программах. Подкоманды являются методами этого объекта.<br>
<strong>@returns</strong> <em>{Object}</em></p>

<h4 id="cmd.name">Cmd.name</h4>

<p>Определяет канонический идентификатор команды, используемый в вызовах API.<br>
<strong>@param</strong> <em>String</em> <code>_name</code> имя команды<br>
<strong>@returns</strong> <em>COA.Cmd</em> <code>this</code> экземпляр команды (для поддержки цепочки методов)</p>

<h4 id="cmd.title">Cmd.title</h4>

<p>Определяет название команды, используемый в текстовых сообщениях.<br>
<strong>@param</strong> <em>String</em> <code>_title</code> название команды<br>
<strong>@returns</strong> <em>COA.Cmd</em> <code>this</code> экземпляр команды (для поддержки цепочки методов)</p>

<h4 id="cmd.cmd">Cmd.cmd</h4>

<p>Создает новую подкоманду или добавляет ранее определенную подкоманду к текущей команде.<br>
<strong>@param</strong> <em>COA.Cmd</em> <code>[cmd]</code> экземпляр ранее определенной подкоманды<br>
<strong>@returns</strong> <em>COA.Cmd</em> экземпляр новой или ранее определенной подкоманды</p>

<h4 id="cmd.opt">Cmd.opt</h4>

<p>Создает параметр для текущей команды.<br>
<strong>@returns</strong> <em>COA.Opt</em> <code>new</code> экземпляр параметра</p>

<h4 id="cmd.arg">Cmd.arg</h4>

<p>Создает аргумент для текущей команды.<br>
<strong>@returns</strong> <em>COA.Opt</em> <code>new</code> экземпляр аргумента</p>

<h4 id="cmd.act">Cmd.act</h4>

<p>Добавляет (или создает) действие для текущей команды.<br>
<strong>@param</strong> <em>Function</em> <code>act</code> функция,
    выполняемая в контексте экземпляра текущей команды
    и принимающая следующие параметры:<br>
        - <em>Object</em> <code>opts</code> параметры команды<br>
        - <em>Array</em> <code>args</code> аргументы команды<br>
        - <em>Object</em> <code>res</code> объект-аккумулятор результатов<br>
    Функция может вернуть проваленный промис из Cmd.reject (в случае ошибки)
    или любое другое значение, рассматриваемое как результат.<br>
<strong>@param</strong> <em>{Boolean}</em> [force=false] флаг, назначающий немедленное исполнение вместо добавления к списку существующих действий<br>
<strong>@returns</strong> <em>COA.Cmd</em> <code>this</code> экземпляр команды (для поддержки цепочки методов)</p>

<h4 id="cmd.apply">Cmd.apply</h4>

<p>Исполняет функцию с переданными аргументами в контексте экземпляра текущей команды.<br>
<strong>@param</strong> <em>Function</em> <code>fn</code><br>
<strong>@param</strong> <em>Array</em> <code>args</code><br>
<strong>@returns</strong> <em>COA.Cmd</em> <code>this</code> экземпляр команды (для поддержки цепочки методов)</p>

<h4 id="cmd.comp">Cmd.comp</h4>

<p>Назначает кастомную функцию автодополнения для текущей команды.<br>
<strong>@param</strong> <em>Function</em> <code>fn</code> функция-генератор автодополнения,
    исполняемая в контексте текущей команды.
    Принимает параметры:<br>
        - <em>Object</em> <code>opts</code> параметры<br>
    Может возвращать промис или любое другое значение, рассматриваемое как результат исполнения команды.<br>
<strong>@returns</strong> <em>COA.Cmd</em> <code>this</code> экземпляр команды (для поддержки цепочки методов)</p>

<h4 id="cmd.helpful">Cmd.helpful</h4>

<p>Ставит флаг поддержки справки командной строки, т.е. вызов команды с параметрами -h --help выводит справку по работе с командой.<br>
<strong>@returns</strong> <em>COA.Cmd</em> <code>this</code> экземпляр команды (для поддержки цепочки методов)</p>

<h4 id="cmd.completable">Cmd.completable</h4>

<p>Добавляет поддержку автодополнения командной строки. Добавляется подкоманда "completion", которая выполняет все необходимые действия.<br>
Может быть добавлен только для главной команды.<br>
<strong>@returns</strong> <em>COA.Cmd</em> <code>this</code> экземпляр команды (для поддержки цепочки методов)</p>

<h4 id="cmd.usage">Cmd.usage</h4>

<p>Возвращает текст справки по использованию команды для текущего экземпляра.<br>
<strong>@returns</strong> <em>String</em> <code>usage</code> Текст справки по использованию</p>

<h4 id="cmd.run">Cmd.run</h4>

<p>Разбирает аргументы из значения, возвращаемого NodeJS process.argv,
и запускает текущую программу, т.е. вызывает process.exit после завершения
всех действий.<br>
<strong>@param</strong> <em>Array</em> <code>argv</code><br>
<strong>@returns</strong> <em>COA.Cmd</em> <code>this</code> экземпляр команды (для поддержки цепочки методов)</p>

<h4 id="cmd.invoke">Cmd.invoke</h4>

<p>Исполняет переданную (или текущую) команду с указанными параметрами и аргументами.<br>
<strong>@param</strong> <em>String|Array</em> <code>cmds</code>  подкоманда для исполнения (необязательно)<br>
<strong>@param</strong> <em>Object</em> <code>opts</code>  параметры, передаваемые команде (необязательно)<br>
<strong>@param</strong> <em>Object</em> <code>args</code>  аргументы, передаваемые команде (необязательно)<br>
<strong>@returns</strong> <em>Q.Promise</em></p>

<h4 id="cmd.reject">Cmd.reject</h4>

<p>Проваливает промисы, возращенные в действиях.<br>
Используется в .act() для возврата с ошибкой.<br>
<strong>@param</strong> <em>Object</em> <code>reason</code> причина провала<br>
    Вы можете определить метод toString() и свойство toString()
    объекта причины провала.<br>
<strong>@returns</strong> <em>Q.promise</em> проваленный промис</p>

<h4 id="cmd.end">Cmd.end</h4>

<p>Завершает цепочку методов текущей подкоманды и возвращает экземпляр родительской команды.<br>
<strong>@returns</strong> <em>COA.Cmd</em> <code>parent</code> родительская команда</p>

<h3 id="opt">Opt</h3>

<p>Параметр — именованная сущность. У параметра может быть определено короткое или длинное имя для использования из командной строки.<br>
<strong>@namespace</strong><br>
<strong>@class</strong> Переданный параметр</p>

<h4 id="opt.name">Opt.name</h4>

<p>Определяет канонический идентификатор параметра, используемый в вызовах API.<br>
<strong>@param</strong> <em>String</em> <code>_name</code> имя параметра<br>
<strong>@returns</strong> <em>COA.Opt</em> <code>this</code> экземпляр параметра (для поддержки цепочки методов)</p>

<h4 id="opt.title">Opt.title</h4>

<p>Определяет описание для параметра, используемое в текстовых сообщениях.<br>
<strong>@param</strong> <em>String</em> <code>_title</code> название параметра<br>
<strong>@returns</strong> <em>COA.Opt</em> <code>this</code> экземпляр параметра (для поддержки цепочки методов)</p>

<h4 id="opt.short">Opt.short</h4>

<p>Назначает ключ для короткого имени параметра, передаваемого из командной строки с одинарным дефисом (например, <code>-v</code>).<br>
<strong>@param</strong> <em>String</em> <code>_short</code><br>
<strong>@returns</strong> <em>COA.Opt</em> <code>this</code> экземпляр параметра (для поддержки цепочки методов)</p>

<h4 id="opt.long">Opt.long</h4>

<p>Назначает ключ для длинного имени параметра, передаваемого из командной строки с двойным дефисом (например, <code>--version</code>).<br>
<strong>@param</strong> <em>String</em> <code>_long</code><br>
<strong>@returns</strong> <em>COA.Opt</em> <code>this</code> экземпляр параметра (для поддержки цепочки методов)</p>

<h4 id="opt.flag">Opt.flag</h4>

<p>Помечает параметр как логический, т.е. параметр не имеющий значения.<br>
<strong>@returns</strong> <em>COA.Opt</em> <code>this</code> экземпляр параметра (для поддержки цепочки методов)</p>

<h4 id="opt.arr">Opt.arr</h4>

<p>Помечает параметр как принимающий множественные значения.<br>
Иначе будет использовано последнее переданное значение параметра.<br>
<strong>@returns</strong> <em>COA.Opt</em> <code>this</code> экземпляр параметра (для поддержки цепочки методов)</p>

<h4 id="opt.req">Opt.req</h4>

<p>Помечает параметр как обязательный.<br>
<strong>@returns</strong> <em>COA.Opt</em> <code>this</code> экземпляр параметра (для поддержки цепочки методов)</p>

<h4 id="opt.only">Opt.only</h4>

<p>Интерпретирует параметр как команду,
т.е. программа будет завершена сразу после выполнения параметра.<br>
<strong>@returns</strong> <em>COA.Opt</em> <code>this</code> экземпляр параметра (для поддержки цепочки методов)</p>

<h4 id="opt.val">Opt.val</h4>

<p>Назначает функцию валидации (или трансформации значения) для значения параметра.<br>
Значение, полученное из командной строки, передается в функцию-валидатор прежде чем оно станет доступно из API.<br>
Используется для валидации и трансформации введенных данных.<br>
<strong>@param</strong> <em>Function</em> <code>_val</code> функция валидации,
    исполняемая в контексте экземпляра параметра
    и принимающая в качестве единственного параметра значение, полученное
    из командной строки<br>
<strong>@returns</strong> <em>COA.Opt</em> <code>this</code> экземпляр параметра (для поддержки цепочки методов)</p>

<h4 id="opt.def">Opt.def</h4>

<p>Назначает значение параметра по умолчанию. Это значение также передается
в функцию валидации как обычное значение.<br>
<strong>@param</strong> <em>Object</em> <code>_def</code><br>
<strong>@returns</strong> <em>COA.Opt</em> <code>this</code> экземпляр параметра (для поддержки цепочки методов)</p>

<h4 id="opt.input">Opt.input</h4>

<p>Помечает параметр как принимающий ввод пользователя. <br>
Позволяет использовать валидацию для STDIN.<br>
<strong>@returns</strong> <em>{COA.Opt}</em> <code>this</code> экземпляр параметра (для поддержки цепочки методов)</p>

<h4 id="opt.output">Opt.output</h4>

<p>Помечает параметр как вывод.<br>
Позволяет использовать валидацию для STDOUT.<br>
<strong>@returns</strong> <em>COA.Opt</em> <code>this</code> экземпляр параметра (для поддержки цепочки методов)</p>

<h4 id="opt.act">Opt.act</h4>

<p>Добавляет (или создает) действие для текущего параметра команды.
Это действие будет выполнено, если текущий параметр есть
в списке полученных параметров (с любым значением).<br>
<strong>@param</strong> <em>Function</em> <code>act</code> функция, выполняемая в контексте
    экземпляра текущей команды и принимающая следующие параметры:<br>
        - <em>Object</em> <code>opts</code> параметры команды<br>
        - <em>Array</em> <code>args</code> аргументы команды<br>
        - <em>Object</em> <code>res</code> объект-аккумулятор результатов<br>
    Функция может вернуть проваленный промис из Cmd.reject (в случае ошибки)
    или любое другое значение, рассматриваемое как результат.<br>
<strong>@returns</strong> <em>COA.Opt</em> <code>this</code> экземпляр параметра (для поддержки цепочки методов)</p>

<h4 id="opt.comp">Opt.comp</h4>

<p>Назначает кастомную функцию автодополнения для текущей команды.<br>
<strong>@param</strong> <em>Function</em> <code>fn</code> функция-генератор автодоплнения, исполняемая в
    контексте экземпляра команды.
    Принимает параметры:<br>
        - <em>Object</em> <code>opts</code> параметры автодополнения<br>
    Может возвращать промис или любое другое значение, рассматриваемое как результат исполнения команды.<br>
<strong>@returns</strong> <em>COA.Opt</em> <code>this</code> экземпляр параметра (для поддержки цепочки методов)</p>

<h4 id="opt.end">Opt.end</h4>

<p>Завершает цепочку методов текущего параметра и возвращает экземпляр родительской команды.<br>
<strong>@returns</strong> <em>COA.Cmd</em> <code>parent</code> родительская команда</p>

<h3 id="arg">Arg</h3>

<p>Аргумент — неименованная сущность.<br>
Аргументы передаются из командной строки как список неименованных значений.</p>

<h4 id="arg.name">Arg.name</h4>

<p>Определяет канонический идентификатор аргумента, используемый в вызовах API.<br>
<strong>@param</strong> <em>String</em> <code>_name</code> имя аргумента<br>
<strong>@returns</strong> <em>COA.Arg</em> <code>this</code> экземпляр аргумента (для поддержки цепочки методов)</p>

<h4 id="arg.title">Arg.title</h4>

<p>Определяет описание для аргумента, используемое в текстовых сообщениях.<br>
<strong>@param</strong> <em>String</em> <code>_title</code> описание аргумента<br>
<strong>@returns</strong> <em>COA.Arg</em> <code>this</code> экземпляр аргумента (для поддержки цепочки методов)</p>

<h4 id="arg.arr">Arg.arr</h4>

<p>Помечает аргумент как принимающий множественные значения.<br>
Иначе будет использовано последнее переданное значение аргумента.<br>
<strong>@returns</strong> <em>COA.Arg</em> <code>this</code> экземпляр аргумента (для поддержки цепочки методов)</p>

<h4 id="arg.req">Arg.req</h4>

<p>Помечает аргумент как обязательный.<br>
<strong>@returns</strong> <em>COA.Arg</em> <code>this</code> экземпляр аргумента (для поддержки цепочки методов)</p>

<h4 id="arg.val">Arg.val</h4>

<p>Назначает функцию валидации (или трансформации значения) для аргумента.<br>
Значение, полученное из командной строки, передается в функцию-валидатор прежде чем оно станет доступно из API.<br>
Используется для валидации и трансформации введенных данных.<br>
<strong>@param</strong> <em>Function</em> <code>_val</code> функция валидации,
    исполняемая в контексте экземпляра аргумента
    и принимающая в качестве единственного параметра значение, полученное
    из командной строки<br>
<strong>@returns</strong> <em>COA.Opt</em> <code>this</code> экземпляр аргумента (для поддержки цепочки методов)</p>

<h4 id="arg.def">Arg.def</h4>

<p>Назначает дефолтное значение для аргумента. Дефолтное значение передается
в функцию валидации как обычное значение.<br>
<strong>@param</strong> <em>Object</em> <code>_def</code><br>
<strong>@returns</strong> <em>COA.Arg</em> <code>this</code> экземпляр аргумента (для поддержки цепочки методов)</p>

<h4 id="arg.output">Arg.output</h4>

<p>Помечает параметр как вывод.<br>
Позволяет назначить валидацию для STDOUT.<br>
<strong>@returns</strong> <em>COA.Arg</em> <code>this</code> экземпляр аргумента (для поддержки цепочки методов)</p>

<h4 id="arg.comp">Arg.comp</h4>

<p>Назначает кастомную функцию автодополнения для текущего аргумента.<br>
<strong>@param</strong> <em>Function</em> <code>fn</code> функция-генератор автодоплнения,
    исполняемая в контексте текущей команды.
    Принимает параметры:<br>
        - <em>Object</em> <code>opts</code> параметры
Может возвращать промис или любое другое значение, рассматриваемое как результат исполнения команды.<br>
<strong>@returns</strong> <em>COA.Arg</em> <code>this</code> экземпляр аргумента (для поддержки цепочки методов)</p>

<h4 id="arg.end">Arg.end</h4>

<p>Завершает цепочку методов текущего аргумента и возвращает экземпляр родительской команды.<br>
<strong>@returns</strong> <em>COA.Cmd</em> <code>parent</code> родительская команда</p>
